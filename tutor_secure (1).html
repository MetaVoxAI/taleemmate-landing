<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>زميل التعليم</title>
</head>
<body style="font-family: 'Arial', sans-serif; background-color: #f0f8ff;">
  <nav style="padding: 10px; background: #007bff; text-align: right; color: white;">
    <span id="user-email" style="float: left; font-weight: bold;"></span>
    <button id="login-button" onclick="showLoginForm()">تسجيل الدخول / إنشاء حساب</button>
    <button id="logout-link" style="display:none;" onclick="logout()">تسجيل الخروج</button>
    <button id="dashboard-link" style="display:none;" onclick="showDashboard()">لوحة التحكم</button>
  </nav>

  <div id="login-modal" style="display:none; text-align:center; margin-top: 50px;">
    <h3>تسجيل الدخول أو إنشاء حساب</h3>
    <input type="email" id="login-email" placeholder="البريد الإلكتروني" /><br /><br />
    <input type="password" id="login-password" placeholder="كلمة المرور" /><br /><br />
    <button onclick="login()">دخول</button>
    <button onclick="signup()">إنشاء حساب</button>
  </div>

  <div class="dashboard" id="dashboard" style="display: none; text-align: center; padding: 40px;">
    <h2>مرحباً بك في لوحة التحكم</h2>
    <p>تابع أسئلتك المحفوظة وتقدمك هنا.</p>
    <div id="user-questions">
      <p>يتم تحميل الأسئلة...</p>
    </div>
  </div>

  <div class="auth-section" id="admin" style="display:none;">
    <h2>لوحة المشرف</h2>
    <div id="admin-content">
      <p>يتم تحميل الأسئلة...</p>
    </div>
  </div>

  <!-- Firebase & Script (same as before) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC-VYpA0Fiul3P70QO1TGG-OTY_nDlcUvc",
      authDomain: "taleemmate.firebaseapp.com",
      projectId: "taleemmate",
      storageBucket: "taleemmate.firebasestorage.app",
      messagingSenderId: "543743794805",
      appId: "1:543743794805:web:5b05edae6656775302223c",
      measurementId: "G-SSN7H48753"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const adminEmails = ["taleemmate@gmail.com"];

    window.auth = auth;
    window.db = db;

    function showLoginForm() {
      document.getElementById("login-modal").style.display = "block";
    }

    function login() {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("تم تسجيل الدخول!");
          document.getElementById("login-modal").style.display = "none";
        })
        .catch(err => alert(err.message));
    }

    function signup() {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("تم إنشاء الحساب!");
          document.getElementById("login-modal").style.display = "none";
        })
        .catch(err => alert(err.message));
    }

    function logout() {
      signOut(auth).then(() => alert("تم تسجيل الخروج."));
    }

    function showDashboard() {
      document.getElementById("dashboard").scrollIntoView({ behavior: "smooth" });
    }

    function renderAdminPanel() {
      const adminContent = document.getElementById("admin-content");
      adminContent.innerHTML = "<p>تحميل...</p>";

      const q = query(collection(db, "questions"), orderBy("timestamp", "desc"));
      getDocs(q)
        .then(snapshot => {
          if (snapshot.empty) {
            adminContent.innerHTML = "<p>لا توجد أسئلة.</p>";
            return;
          }

          const table = document.createElement("table");
          table.style.width = "100%";
          table.border = "1";
          const header = document.createElement("tr");
          header.innerHTML = "<th>البريد</th><th>السؤال</th><th>التاريخ</th><th>الإجراء</th>";
          table.appendChild(header);

          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${data.email || "غير معروف"}</td>
              <td>${data.question}</td>
              <td>${new Date(data.timestamp?.toDate()).toLocaleString()}</td>
              <td><button onclick="deleteQuestion('${docSnap.id}')">حذف</button></td>
            `;
            table.appendChild(row);
          });

          adminContent.innerHTML = "<h3>أحدث الأسئلة</h3>";
          adminContent.appendChild(table);
        })
        .catch(error => {
          adminContent.innerHTML = `<p>خطأ في التحميل: ${error.message}</p>`;
        });
    }

    function deleteQuestion(id) {
      if (confirm("هل تريد حذف هذا السؤال؟")) {
        deleteDoc(doc(db, "questions", id))
          .then(() => {
            alert("تم الحذف.");
            renderAdminPanel();
          })
          .catch(error => {
            alert("خطأ في الحذف: " + error.message);
          });
      }
    }

    function renderUserDashboard(user) {
      const userQuestions = document.getElementById("user-questions");
      userQuestions.innerHTML = "<p>جارٍ تحميل أسئلتك...</p>";

      const q = query(collection(db, "questions"), where("uid", "==", user.uid), orderBy("timestamp", "desc"));
      getDocs(q)
        .then(snapshot => {
          if (snapshot.empty) {
            userQuestions.innerHTML = "<p>لم تقم بإرسال أي سؤال.</p>";
            return;
          }

          const list = document.createElement("ul");
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const item = document.createElement("li");
            item.innerHTML = `<em>${data.question}</em> <br><small>${new Date(data.timestamp?.toDate()).toLocaleString()}</small>`;
            list.appendChild(item);
          });

          userQuestions.innerHTML = "<h3>أسئلتك</h3>";
          userQuestions.appendChild(list);
        })
        .catch(error => {
          userQuestions.innerHTML = `<p>حدث خطأ: ${error.message}</p>`;
        });
    }

    onAuthStateChanged(auth, user => {
      const dashboardLink = document.getElementById("dashboard-link");
      const logoutLink = document.getElementById("logout-link");
      const userEmail = document.getElementById("user-email");
      const dashboard = document.getElementById("dashboard");
      const adminSection = document.getElementById("admin");

      if (user) {
        dashboardLink.style.display = "inline";
        logoutLink.style.display = "inline";
        userEmail.textContent = user.email;
        dashboard.style.display = "block";
        renderUserDashboard(user);

        if (adminEmails.includes(user.email)) {
          adminSection.style.display = "block";
          renderAdminPanel();
        } else {
          adminSection.style.display = "none";
        }
      } else {
        dashboardLink.style.display = "none";
        logoutLink.style.display = "none";
        userEmail.textContent = "";
        dashboard.style.display = "none";
        adminSection.style.display = "none";
      }
    });
  </script>
</body>
</html>
